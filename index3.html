<!doctype html>
<html lang="en">

<head>
	<!-- Required meta tags -->
	<meta charset="utf-8">
	<!-- <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- <link rel="stylesheet" type="text/css" href="css/main.css"> -->

	<!-- JavaScript file -->

	<!-- Bootstrap CSS -->
	<!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous"> -->
	<style>
		/* body {
			font-family: 'Roboto', sans-serif;
			font-weight: bold;
			font-size: 16px;
			color: #2C3E50;
		} */

		/* a {
			color: #D25627;
			text-decoration: none;
		}

		.btn-primary {
			background-color: #D25627;
			border-color: #D25627;
		}
		.btn{
			font-size: 14px;
			font-weight: bold;

		} */
		#loading {
			display: block;
			margin: auto;
			width: 50%;
		}

		/* #container1 {
			display: none
		}

		#container2 {
			display: none
		} */

		#file_container {
			display: none;
		}

		.center {
			display: block;
			margin-left: auto;
			margin-right: auto;
			width: 50%;
		}
	</style>
	<style type="text/css">
		@keyframes ldio-5893fgiiwzd {
			0% {
				opacity: 1
			}

			100% {
				opacity: 0
			}
		}

		.ldio-5893fgiiwzd div {
			left: 102.60000000000001px;
			top: 61.56px;
			position: absolute;
			animation: ldio-5893fgiiwzd linear 1s infinite;
			background: #d25627;
			width: 10.8px;
			height: 6.48px;
			border-radius: 0.324px / 0.324px;
			transform-origin: 5.4px 46.440000000000005px;
		}

		.ldio-5893fgiiwzd div:nth-child(1) {
			transform: rotate(0deg);
			animation-delay: -0.9166666666666666s;
			background: #d25627;
		}

		.ldio-5893fgiiwzd div:nth-child(2) {
			transform: rotate(30deg);
			animation-delay: -0.8333333333333334s;
			background: #d25627;
		}

		.ldio-5893fgiiwzd div:nth-child(3) {
			transform: rotate(60deg);
			animation-delay: -0.75s;
			background: #d25627;
		}

		.ldio-5893fgiiwzd div:nth-child(4) {
			transform: rotate(90deg);
			animation-delay: -0.6666666666666666s;
			background: #d25627;
		}

		.ldio-5893fgiiwzd div:nth-child(5) {
			transform: rotate(120deg);
			animation-delay: -0.5833333333333334s;
			background: #d25627;
		}

		.ldio-5893fgiiwzd div:nth-child(6) {
			transform: rotate(150deg);
			animation-delay: -0.5s;
			background: #d25627;
		}

		.ldio-5893fgiiwzd div:nth-child(7) {
			transform: rotate(180deg);
			animation-delay: -0.4166666666666667s;
			background: #d25627;
		}

		.ldio-5893fgiiwzd div:nth-child(8) {
			transform: rotate(210deg);
			animation-delay: -0.3333333333333333s;
			background: #d25627;
		}

		.ldio-5893fgiiwzd div:nth-child(9) {
			transform: rotate(240deg);
			animation-delay: -0.25s;
			background: #d25627;
		}

		.ldio-5893fgiiwzd div:nth-child(10) {
			transform: rotate(270deg);
			animation-delay: -0.16666666666666666s;
			background: #d25627;
		}

		.ldio-5893fgiiwzd div:nth-child(11) {
			transform: rotate(300deg);
			animation-delay: -0.08333333333333333s;
			background: #d25627;
		}

		.ldio-5893fgiiwzd div:nth-child(12) {
			transform: rotate(330deg);
			animation-delay: 0s;
			background: #d25627;
		}

		.loadingio-spinner-spinner-m3vtpi6xlmd {
			width: 216px;
			height: 216px;
			display: block;
			overflow: hidden;
			margin-left: auto;
			margin-right: auto;
			background: #fcfcfc;
		}

		.ldio-5893fgiiwzd {
			width: 100%;
			height: 100%;
			position: relative;
			transform: translateZ(0) scale(1);
			backface-visibility: hidden;
			transform-origin: 0 0;
			/* see note above */
		}

		.ldio-5893fgiiwzd div {
			box-sizing: content-box;
		}

		/* generated by https://loading.io/ */
	</style>
	<title>GenBank Query Results</title>
</head>

<body>
	<div id="loading">
		<h3 class="text-center" id="state_txt">Waiting for response...</h3>
		<div class="loadingio-spinner-spinner-m3vtpi6xlmd">
			<div class="ldio-5893fgiiwzd">
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
			</div>
		</div>
	</div>

	<div id="file_container" class="container">
		<div class="row">
			<div class="col">
				<!-- <div class="page-header"> -->
					<h1 class="text-center"> GENBANK RESULTS </h1>
				<!-- </div> -->
			</div>
		</div>
		<!-- <br> -->
		<div class="row">
			<div class="col">
				<h4>Filter Matches</h4>
			</div>
		</div>
		<div class="row align-items-center gy-2 mt-1">
            <table class="attachements-table table">
                <tbody>
                    <tr>
                        <td>
                            <label style="font-size: medium;">
                                Min % Identity Coverage:
                            </label>
                            <input type="number" id="minPCT" step="0.1" max="100" min="0">
                        </td>
                        <td>
                            <label style="font-size: medium;">
                                Min % Query Coverage:
                            </label>
                            <input type="number" id="minQ" step="0.1" max="100" min="0">
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2">
                            <div class="form-check">
                                <input class="form-check-input" onclick="check_callback()" type="checkbox" value=""
                                    id="flexCheckDefault">
                                <label id="myCheck" class="form-check-label" for="flexCheckDefault">
                                    Exact Matches Only
                                </label>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2">
                            <button onclick="FilterDropDown()" type="button" class="btn btn-primary btn	"><svg
                                xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                class="bi bi-filter" viewBox="0 0 16 16">
                                <path
                                    d="M6 10.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5zm-2-3a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm-2-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5z" />
                            </svg>Filter</button>
                            <div class="btn-group">
                                <li class="dropdown btn btn-primary">
                                    <span class="hidden-xs hidden-sm">Select GenBank File</span>
                                    <span class="caret"></span>
                                    <ul id="dropdown" class="dropdown-menu dropdown-toggle"></ul>
                                </li>
                            </div>
                        </td>

                    </tr>
                </tbody>
            </table>
			<!-- <div class="col"> -->

			<!-- </div> -->
			<!-- <div class="col"> -->
				<!-- <div class="row align-items-center g-0"> -->
					<!-- <div class="col"> -->

					<!-- </div> -->
					<!-- <div class="col"> -->

					<!-- </div> -->
					<!-- <div class="col"> -->

					<!-- </div> -->

				<!-- </div> -->
				<!-- <div class="row align-items-center g-0"> -->
					<!-- <div class="col"> -->

					<!-- </div> -->
					<!-- <div class="col"> -->
					<!-- </div> -->
					<!-- <div class="col"> -->


					<!-- </div> -->
				<!-- </div> -->


			<!-- </div> -->
		</div>
		<div id="middle-txt" class="row gy-2 mt-1">
			<hr />
			<div class="col-9">
				<h4 id="definition">Definition</h4>
				<h5 id="locus" style="font-style: italic;">Locus</h5>
			</div>
			<div class="col align-self-end">
				Score: <span id="score"></span>&nbsp;&nbsp;&nbsp;&nbsp;
				Query Coverage: <span id="qcov"></span>%&nbsp;&nbsp;&nbsp;&nbsp;
				Identity: <span id="identity"></span>%
			</div>
		</div>

		<div id="table-holder" class="row gy-2 mt-1">
			<div class="col">
				<table id="dataTable" class="table table-striped table-hover">
				</table>
			</div>
		</div>
		<div id="no-results" class="center" style="display: none;">
			No results match criteria
		</div>
	</div>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf"
		crossorigin="anonymous"></script>
	<!-- <script src="js/plugin.js"></script> -->

	<script>
		var json_data = [];
		var filtered_data = [];

		// Loads the drop down menu and table
		function load_drop() {
			var dropper = document.getElementById("dropdown")
			dropper.innerHTML = "";
			for (set in filtered_data) {
				// Please don't judge me
				var tmp = document.createElement("li");
				tmp.innerHTML = '<a onClick="load_table(this.textContent)">%ID%</a>';
				// tmp.innerHTML = '<button class="dropdown-item" type="button" onClick="load_table(this.textContent)">%ID%</button>';
				// tmp.innerHTML = tmp.innerHTML.replace(/%ID%/g, filtered_data[set].id);
				tmp.innerHTML = tmp.innerHTML.replace(/%ID%/g, filtered_data[set].accession);
				dropper.append(tmp)
			}
		}

		function FilterDropDown() {
			var min_q = document.getElementById("minQ").value;
			var min_p = document.getElementById("minPCT").value;
			filtered_data = []
			for (set in json_data) {
				var data = json_data[set];
				if (data.per_cov > min_q && data.per_id > min_p) {
					filtered_data.push(json_data[set])
				}
			}
			if (filtered_data.length == 0) {
				load_table("");
				document.getElementById("middle-txt").style.visibility = 'hidden';
				document.getElementById("table-holder").style.visibility = 'hidden';
				show("no-results", true);
			}
			else {
				// load_table(filtered_data[0].id);
				load_table(filtered_data[0].accession);
				load_drop();
				show("no-results", false);
				document.getElementById("middle-txt").style.visibility = 'visible';
				document.getElementById("table-holder").style.visibility = 'visible';
			}
		}
		function check_callback() {
			var min_q = document.getElementById("minQ");
			var min_p = document.getElementById("minPCT");
			if (min_q.value == 100 && min_p.value == 100) {
				min_q.value = 0;
				min_q.disabled = false;
				min_p.value = 0;
				min_p.disabled = false;
			}
			else {
				min_q.value = 100;
				min_q.disabled = true;
				min_p.value = 100;
				min_p.disabled = true;
			}
		}
		function load_pubdata(key, datum, oldCount){
			var table = document.getElementById("dataTable");
			var pub = filtered_data[key].data["pubdata"][datum];
			var rowCount = table.rows.length;
			while (rowCount != oldCount){
				table.deleteRow(-1);
				rowCount = table.rows.length;
			}
			for (info in pub){
				var rowCount = table.rows.length;
				var row = table.insertRow(rowCount);
				row.insertCell(0).innerHTML = info;
				row.insertCell(1).innerHTML = pub[info];
			}
		}
		function load_table(name) {
			var score = document.getElementById("score");
			var qcov = document.getElementById("qcov");
			var identity = document.getElementById("identity");
			var table = document.getElementById("dataTable");
			var locus = document.getElementById("locus");
			var def = document.getElementById("definition");

			// Quick way to wipe the rows
			table.innerHTML = "";
			score.textContent = "";
			qcov.textContent = "";
			identity.textContent = "";
			locus.textContent = "Locus";
			def.textContent = "Definition";

			// Get data for accession id
			for (keys in filtered_data) {
				// if (filtered_data[keys].id == name) {
				if (filtered_data[keys].accession == name) {
					score.textContent = filtered_data[keys].score;
					qcov.textContent = filtered_data[keys].per_cov;
					identity.textContent = filtered_data[keys].per_id;

					var data = filtered_data[keys].data;
					console.log(filtered_data[keys].data)
					for (datum in data) {
						console.log(datum)
						var rowCount = table.rows.length;
						if (datum == "Locus") {
							locus.textContent = filtered_data[keys].data[datum]
						}
						else if (datum == "Definition") {
							def.textContent = filtered_data[keys].data[datum]
						}
						else if (datum == "pubdata"){
							var row = table.insertRow(rowCount);
							row.id = "pubDrop";
							var script = '<li class="dropdown btn btn-primary"><span class="hidden-xs hidden-sm">Select Publication</span><span class="caret"></span><ul id="dropdown" class="dropdown-menu dropdown-toggle"></ul></li>' 
							row.insertCell(0).innerHTML = '';
							row.insertCell(1).innerHTML = script;
							rowCount = table.rows.length;
							var pubDrop = document.getElementById("pubDrop")
							for (publication in filtered_data[keys].data[datum]) {
								var tmp = document.createElement("li");
								tmp.innerHTML = '<a onClick="load_pubdata(' + String(keys) + ',' + String(publication) + ',' + String(rowCount) + ')">%ID%</a>';
								var string  = filtered_data[keys].data[datum][publication]["Publication Title"].slice(0,48);
								if (string.length == 48){
									string += "...";
								}
								if (filtered_data[keys].data[datum][publication]["Date Published"]){
									string += "(" + filtered_data[keys].data[datum][publication]["Date Published"].slice(-4,) + ")"
								}
								tmp.innerHTML = tmp.innerHTML.replace(/%ID%/g, string);
								pubDrop.append(tmp)
							}
						}
						else {
							var row = table.insertRow(rowCount);
							row.id = datum;
							row.insertCell(0).innerHTML = datum;
							if (datum == "Link") {
								row.insertCell(1).innerHTML = '<a href="%LINK%">%LINK%</a>'.replace(/%LINK%/g, filtered_data[keys].data[datum]);
							}
							else {
								row.insertCell(1).innerHTML = filtered_data[keys].data[datum];
							}
						}
					}
					break
				}
			}
		}
		function onReady(callback) {
			console.log("hello")
			var intervalID = window.setInterval(checkReady, 2000);

			function checkReady() {

				//var commNode_url = 'COMM_NODE_IP'
				//var query_id = 'QUERY_ID'

				var commNode_url = 'http://192.168.0.137:5000/'
				var query_id = 'a1234'

				const entryPoint = fetch(commNode_url + 'plugin_poll/' + query_id);
				entryPoint.then((response) => {
					if (!response.ok) {
						throw new Error("HTTP status " + response.status);
					}
					return response.json();
				})
				.then((result) => {
					const state = result.State;
					console.log(state);
					document.getElementById("state_txt").textContent = state;
					if (state == "Done") {
						window.clearInterval(intervalID);
						delete result.State;
						json_data = result.results;
						filtered_data = result.results;
						load_drop()
						load_table(filtered_data[0].accession);
						callback.call(this);
					}
				})
				.catch((e) => {
					console.log(e);
					window.clearInterval(intervalID);

				})
				// window.clearInterval(intervalID);
				// filtered_data = [
				// 		{
				// 			"accession": "D26185",
				// 			"score": 237,
				// 			"per_cov": 76.0,
				// 			"per_id": 100.0,
				// 			"data": {
				// 				"Link": "https://www.ncbi.nlm.nih.gov/nuccore/D26185",
				// 				"Locus": "BAC180K",
				// 				"Definition": "Bacillus subtilis gene, 180 kilobase region of replication origin.",
				// 				"Source": "Bacillus subtilis subsp. subtilis str. 168",
				// 				"Reference": " AUTHORS   Moriya,S., Ogasawara,N. and Yoshikawa,H.",
				// 				"Authors": "Moriya,S., Ogasawara,N. and Yoshikawa,H.",
				// 				"Publication Title": "Structure and function of the region of the replication origin of the Bacillus subtilis chromosome. III. Nucleotide sequence of some 10,000 base pairs in the origin region",
				// 				"Journal": "Nucleic Acids Res. 13 (7), 2251-2265 (1985)",
				// 				"PubMed ID": "2987847"
				// 			}
				// 		},
				// 		{
				// 			"accession": "J01552",
				// 			"score": 100,
				// 			"per_cov": 32.0,
				// 			"per_id": 100.0,
				// 			"data": {
				// 				"Link": "https://www.ncbi.nlm.nih.gov/nuccore/J01552",
				// 				"Locus": "BACVEGPRO",
				// 				"Definition": "Bacillus subtilis veg gene promoter region.",
				// 				"Source": "Bacillus subtilis",
				// 				"Reference": "(bases 1 to 127)",
				// 				"Authors": "Le Grice,S.F. and Sonenshein,A.L.",
				// 				"Publication Title": "Interaction of Bacillus subtilis RNA polymerase with a chromosomal promoter",
				// 				"Journal": "J. Mol. Biol. 162 (3), 551-564 (1982)",
				// 				"PubMed ID": "6820069"
				// 			}
				// 		},
				// 		{
				// 			"accession": "V00635",
				// 			"score": 47,
				// 			"per_cov": 15.0,
				// 			"per_id": 100.0,
				// 			"data": {
				// 				"Link": "https://www.ncbi.nlm.nih.gov/nuccore/V00635",
				// 				"Locus": "V00635",
				// 				"Definition": "Genes cro cII and oop of the lambdoid phage 434.",
				// 				"Source": "Phage 434",
				// 				"Reference": "(bases 1 to 873)",
				// 				"Authors": "Grosschedl,R. and Schwarz,E.",
				// 				"Publication Title": "Nucleotide sequence of the cro-cII-oop region of bacteriophage 434\n         ",
				// 				"Journal": "Nucleic Acids Res. 6 (3), 867-881 (1979)",
				// 				"PubMed ID": "375198"
				// 			}
				// 		},
				// 		{
				// 			"accession": "U02447",
				// 			"score": 47,
				// 			"per_cov": 15.0,
				// 			"per_id": 100.0,
				// 			"data": {
				// 				"Link": "https://www.ncbi.nlm.nih.gov/nuccore/U02447",
				// 				"Locus": "CVU02447",
				// 				"Definition": "Cloning vector lambda gt10, region flanking the cloning site.",
				// 				"Source": "Cloning vector lambda gt10",
				// 				"Reference": "(bases 1 to 1881)",
				// 				"Authors": "Huynh,T.V., Young,R.A. and Davis,R.W.",
				// 				"Publication Title": "Construction and screening cDNA libraries in lambda gt10 and lambda gt11",
				// 				"Journal": "(in) Glover,D.M. (Ed.);"
				// 			}
				// 		},
				// 		{
				// 			"accession": "M28306",
				// 			"score": 47,
				// 			"per_cov": 15.0,
				// 			"per_id": 100.0,
				// 			"data": {
				// 				"Link": "https://www.ncbi.nlm.nih.gov/nuccore/M28306",
				// 				"Locus": "SYNCRO434P",
				// 				"Definition": "Cloning vector pBRcro434.",
				// 				"Source": "Cloning vector pBRcro434",
				// 				"Reference": "(bases 1 to 180)",
				// 				"Authors": "Bespalova,I.N., Rubtsov,P.M., Kirpichnikov,M.P. and Skryabin,K.G.",
				// 				"Publication Title": "C1 and cro repressors of lambdoid phages. I. Construction of vectors for expression of lambda imm-434 bacteriophage cro repressor",
				// 				"Journal": "Mol. Biol. (Mosk) 18, 20-27 (1984)"
				// 			}
				// 		},
				// 		{
				// 			"accession": "X73093",
				// 			"score": 47,
				// 			"per_cov": 15.0,
				// 			"per_id": 100.0,
				// 			"data": {
				// 				"Link": "https://www.ncbi.nlm.nih.gov/nuccore/X73093",
				// 				"Locus": "X73093",
				// 				"Definition": "Bacteriophage 434 right operator.",
				// 				"Source": "Phage 434",
				// 				"Reference": "(bases 1 to 116)",
				// 				"Authors": "Bushman,F.D.",
				// 				"Publication Title": "The bacteriophage 434 right operator. Roles of O(R)1, O(R)2 and O(R)3",
				// 				"Journal": "J. Mol. Biol. 230 (1), 28-40 (1993)",
				// 				"PubMed ID": "8450541"
				// 			}
				// 		},
				// 		{
				// 			"accession": "M12803",
				// 			"score": 47,
				// 			"per_cov": 15.0,
				// 			"per_id": 100.0,
				// 			"data": {
				// 				"Link": "https://www.ncbi.nlm.nih.gov/nuccore/M12803",
				// 				"Locus": "P434OPRA",
				// 				"Definition": "Bacteriophage 434 operator region DNA with recognition sites for repressor and cro proteins.",
				// 				"Source": "Phage 434",
				// 				"Reference": "(bases 1 to 67)",
				// 				"Authors": "Wharton,R.P., Brown,E.L. and Ptashne,M.",
				// 				"Publication Title": "Substituting an alpha-helix switches the sequence-specific DNA interactions of a repressor",
				// 				"Journal": "Cell 38 (2), 361-369 (1984)",
				// 				"PubMed ID": "6540625"
				// 			}
				// 		},
				// 		{
				// 			"accession": "J02460",
				// 			"score": 47,
				// 			"per_cov": 15.0,
				// 			"per_id": 100.0,
				// 			"data": {
				// 				"Link": "https://www.ncbi.nlm.nih.gov/nuccore/J02460",
				// 				"Locus": "LAMIMM434",
				// 				"Definition": "bacteriophage lambda imm434 ecori-g fragment.",
				// 				"Source": "Escherichia virus Lambda",
				// 				"Reference": "(bases 1 to 1287)",
				// 				"Authors": "Ovchinnikov,Y.A., Guryev,S.O., Krayev,A.S., Monastyrskaya,G.S., Skryabin,K.G., Sverdlov,E.D., Zakharyev,V.M. and Bayev,A.A.",
				// 				"Publication Title": "Primary structure of an EcoRI fragment of lambda imm434 DNA containing regions cI-cro of phage 434 and cII-o of phage lambda",
				// 				"Journal": "Gene 6 (3), 235-249 (1979)",
				// 				"PubMed ID": "478301"
				// 			}
				// 		},
				// 		{
				// 			"accession": "M12904",
				// 			"score": 47,
				// 			"per_cov": 15.0,
				// 			"per_id": 100.0,
				// 			"data": {
				// 				"Link": "https://www.ncbi.nlm.nih.gov/nuccore/M12904",
				// 				"Locus": "SYN322CI",
				// 				"Definition": "Bacteriophage 434 cI gene inserted in plasmid pNS1.",
				// 				"Source": "unidentified cloning vector",
				// 				"Reference": "(bases 1 to 970)",
				// 				"Authors": "Nikolnikov,S., Posfai,G. and Sain,B.",
				// 				"Publication Title": "The construction of a versatile plasmid vector that allows direct selection of fragments cloned into six unique sites of the cI gene of coliphage 434",
				// 				"Journal": "Gene 30 (1-3), 261-265 (1984)",
				// 				"PubMed ID": "6096221"
				// 			}
				// 		}
				// 	]
				// load_drop()
				// load_table(filtered_data[0].accession);
				// callback.call(this);
			}
		}

		function show(id, value) {
			document.getElementById(id).style.display = value ? 'block' : 'none';
		}
		onReady(function () {
			show('loading', false);
			show('file_container', true);
			//show('container2', true)
		});

	</script>






</body>

</html>